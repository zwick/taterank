#!/bin/bash

echo "Checking dependencies..."

echo "Checking Docker..."
if ! command -v docker &>/dev/null; then
  echo "Docker not found. Please install Docker."
  exit 1
else
  echo "Docker is installed."
fi

echo "Checking Golang..."
if ! command -v go &>/dev/null; then
  echo "Golang not found. Please install Golang."
else
  echo "Golang is installed."
fi

echo "Checking if Localstack container is running..."
if ! docker ps | grep -q localstack; then
  echo "Localstack container not found. Starting Localstack..."
  docker compose up -d localstack
  echo "Localstack container started."
else
  echo "Localstack container is running, continuing..."
fi

echo "Running Terraform..."
docker run --rm --net=host -v "$(pwd)/infrastructure:/app" -w /app hashicorp/terraform:latest init -input=false
docker run --rm --net=host -v "$(pwd)/infrastructure:/app" -w /app hashicorp/terraform:latest apply -input=false -auto-approve
echo "Terraform complete!"

echo "Spinning down Localstack..."
docker compose down localstack
echo "Localstack spun down."

echo "Bootstrap complete!"
